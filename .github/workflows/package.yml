# packaging for release builds

name: Package

on: [push]

jobs:
  fpm:
    name: ${{ matrix.pkg }}
    runs-on: ${{ matrix.os }}-latest
    needs: [build]

    strategy:
      fail-fast: false
      matrix:
        # others: cpan, gem, npm, osxpkg, p5p, pacman, pear, pkgin, pleaserun, puppet, python, snap, solaris, virtualenv ]
        pkg: [ apk, deb, dir, freebsd, rpm, sh, tar, zip ]
        san: [ NO_SANITIZER ] # NO_SANITIZER=1 is a no-op
        os: [ ubuntu ]
        cc: [ clang ]
        make: [ bmake ]
        debug: [ RELEASE ] # RELEASE=1 is a no-op

    - name: Dependencies (Ubuntu)
      if: matrix.os == 'ubuntu'
      run: |
        uname -a
        sudo apt-get install bmake pcregrep
        sudo gem install --no-document fpm
        fpm -v
        ${{ matrix.cc }} --version

    - name: Fetch build
      uses: actions/cache@v3
      id: cache-build
      with:
        path: .
        key: ${{ matrix.make }}-${{ matrix.os }}-${{ matrix.cc }}-${{ matrix.debug }}-${{ matrix.san }}-${{ github.sha }}

    - name: Install
      run: |
        bmake -r -j 2 PKGCONF=pkg-config CC=${{ matrix.cc }} PREFIX=prefix/usr install

    - name: Package
      run: |
        mkdir pkg
        fpm -C prefix -p pkg/ -n libfsm -t ${{ matrix.pkg }} -v 0.${{ github.sha }} -m kate@elide.org -s dir

    - name: Upload
      uses: actions/upload-artifact@v2
      with:
        name: ${{ github.sha }} ${{ matrix.pkg }}
        path: pkg/* # single file here (because this is a matrix build), name format differs per package type     

